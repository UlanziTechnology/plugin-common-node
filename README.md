# ulanzideck-plugin-sdk-node

<p align="start">
   <strong>English</strong> | <a href="./README.zh.md">简体中文</a>
</p>

## Introduction
The ulanzideck-plugin-sdk encapsulates the WebSocket connection with the UlanziDeck and its related communication events. This simplifies the development process and enables developers to communicate with the UlanziDeck through simple event calls, allowing them to focus more on the development of plugin functions.


```bash
The current version is developed according to the Ulanzi JS Plugin Development Protocol - V1.2.1.
```


## File directory
```bash
plugin-common-node   //ulanzideck-plugin-sdk node package
├── libs
│   ├── constants.js      //Event constants of the UlanziDeck
│   ├── randomPort.js      //Generate a random port for the node service
│   ├── utils.js          //Encapsulation of some common methods
│   └── ulanzideckApi.js    //This includes the encapsulation of all UlanziDeck events, websocket connection
├── index.js  //Entry file
```


## Instructions

### Some instructions and conventions

1. The main service of the plugin library (for example app.js) will always be connected to the UlanziDeck. Implement the main functions of the plugin, receive changes to action's params, update the status of icons, etc.

2. The action of the plugin library (for example inspector.html). The page will be destroyed after toggling the UlanziDeck button, so it is not appropriate to do functional processing. It is mainly used to send params to UlanziDeck and synchronize params from UlanziDeck.

3. For unified management, the name of our plugin package is com.ulanzi.pluginname.ulanziPlugin

4. For the normal use of the ulanzideck-plugin-sdk library, we agree that the uuid length of the main service connection is 4. Example: com.ulanzi.ulanzideck.pluginname

5. The uuid of the action connection must be greater than 4 for differentiation. Example: com.ulanzi.ulanzideck.pluginname.pluginaction

6. When using node as the main service, in order to avoid port conflicts, use the RandomPort provided by plugin-common-node to generate ports. For details, see [<a href="#title-2">2. Generate random port</a>]

7. Due to the difference between the local node environment and the host node environment, and some bugs that will occur when the local path is obtained after the program is packaged, we provide the <strong>Utils.getPluginPath()</strong> method to obtain the local path of the plugin root, which you can use as needed. For details, see [<a href="#title-3">3. Get the path to the root directory of the plugin</a>]


### How to use

#### * context （A special parameter）

An action function may be configured on multiple keys, so the ulanzideck-plugin-sdk library concatenates a unique value <strong>context</strong>. When we create a feature instance, we only need to save the unique value <strong>context</strong>. If you need to update the data, you can send the message to the corresponding key value based on the corresponding unique value <strong>context</strong>.

```bash
1. The special parameter context, which is a unique value concatenated from the common library, is passed to the main service and action along with the received message。

2. The concatenation rule for context is uuid + '___' + key + '__' + actionid, generated by the corresponding $UD.encodeContext(msg).

3. We also provide $UD.decodeContext(context) to deconstruct unique values and return { uuid, key, actionid }.

4. Since the param of the clear event is in the form of an array, the context of clear is spliced ​​into the param. Please pay attention to loop acquisition when doing clear processing.

```

#### 1. Install

1. Download <strong>plugin-common-node</strong> locally and copy the folder to the running directory.
2. <strong>plugin-common-node</strong> is based on <strong>ws</strong>, so you need to install <strong>ws</strong> dependency packages in the project root directory.
3. Then you can reference it according to the location of the folder.

#### <span id="title-2">2. Generate random port</span>

After calling the method <strong>getPort()</strong> of the randomly generated interface, a ws-port.js will be automatically generated under the main service of the plugin, and the content of the js file is <strong>window.__port = port number</strong>;
The HTML of the action can be connected to the main node service by introducing a 'ws-port.js' file to get the port of the main service


```js
import { RandomPort } from './actions/plugin-common-node/index.js';

const generatePort = new RandomPort(); 

//Generate random port
const port = generatePort.getPort(); 

```


#### <span id="title-3">3. Get the path to the root directory of the plugin</span>

The <strong>Utils.getPluginPath()</strong> method can obtain the local path of the root directory of the plugin, which is compatible with Windows and Mac systems, and can be used as needed.

```js
import { Utils } from './actions/plugin-common-node/index.js';

//获取根目录文件路径
const _pluginPath = Utils.getPluginPath()

console.log('Plugin path: ', _pluginPath)

```



#### 4. Connect the UlanziDeck
Take the action's html page as an example to briefly demonstrate some methods. For details, please see[<a href="#title-5">5. Receive events(UlanziDeck->plugin)</a>][<a href="#title-6">6. Send Events(plugin->UlanziDeck)</a>]
```js
  import { UlanzideckApi } from './actions/plugin-common-node/index.js';;

  const $UD = new UlanzideckApi();
  //Connect to the websocket of the UlanziDeck. After successful connection, the event onConnected will be triggered
  $UD.connect('com.ulanzi.ulanzideck.teamspeak5');

  $UD.onConnected(conn => {
    //Connected
  })

  //Receive events when action is dragged into the keyboard
  $UD.onAdd( message => {
    //Save the action instance
  })

  //Receive the action initialization parameters
  $UD.onParamFromApp( message => {
      //Save action initialization parameters
  })


  //Receive plugin clear events
  $UD.onClear( message => {
    if(message.param){
      for(let i = 0; i<message.param.length; i++){
        const context = message.param[i].context
        console.log('===context clear', context)

      }
    }
  })

  //Set the UlanziDeck icon
  function serIcon(context, data, text){
    $UD.setBaseDataIcon(context, data, text) 
  }


```

#### <span id="title-5" >5. Receive events(UlanziDeck->plugin)</span>
```js
/**
 * Listen for events from websocket connections and events from the UlanziDeck
*/
1. $UD.onConnected(conn => ())  //The websocket connection to the UlanziDeck is successful
2. $UD.onClose(conn => ())  //The websocket connection is closed
3. $UD.onError(conn => ())  //websocket connection error
4. $UD.onAdd(message => ())     //Receive event "cmd": "add" from UlanziDeck
5. $UD.onParamFromApp(message => ())  //Receive event "cmd": "paramfromapp" from UlanziDeck
6. $UD.onParamFromPlugin(message => ())  //Receive event "cmd": "paramfromplugin" from UlanziDeck
7. $UD.onRun(message => ())  //Receive event "cmd": "run" from UlanziDeck
8. $UD.onSetActive(message => ())  //Receive event "cmd": "setactive" from UlanziDeck
9. $UD.onClear(message => ())  //Receive event "cmd": "clear" from UlanziDeck
10. $UD.onSelectdialog(message => ())  //Receive event "cmd": "selectdialog" from UlanziDeck.Used to receive the results of selecting files/folders

```

#### <span id="title-6">6. Send Events(plugin->UlanziDeck)</span>

```js
/**
 * Send  parameters to the UlanziDeck
 * @param {object} settings Required | parameters
 * @param {object} context Optional | Unique value。It is not required to be passed. It does not need to be passed when it is sent from the action page. It must be passed when it is sent from the main service.
*/
1. $UD.sendParamFromPlugin(settings, context) 

/**
 * Set icon - use the icon list number in the configuration, please refer to manifest.json.
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {number} state Required | Icon list number
 * @param {string} text Optional | Whether the icon displays text
*/
2. $UD.setStateIcon(context, state, text) 


  /**
 * Set icon - use custom icon
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {string} data Required | icon in base64 format
 * @param {string} text Optional | Whether the icon displays text
*/
3. $UD.setBaseDataIcon(context, data, text) 


/**
 * Set icon-use local image file
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {string} path  Required | Local image path, supports opening URL links under the plugin root directory (links starting with / ./)
 * @param {string} text Optional | Whether the icon displays text
*/
4. $UD.setPathIcon(context, path, text) 


/**
 * Set icon - use custom gif
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {string} gifdata Required | Base64 encoded data of custom gif
 * @param {string} text Optional | Whether the icon displays text
*/
5. $UD.setGifDataIcon(context, gifdata, text) 



  /**
 * Set icon - use local gif file
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.，
 * @param {string} gifdata  Required | Local gif image path, supports opening URL links under the plugin root directory (links starting with / ./)
 * @param {string} text Optional | Whether the icon displays text
*/
6. $UD.setGifPathIcon(context, gifpath, text) 


/**
 * A toast message pops up on the requesting UlanziDeck
 *  @param {string} msg Required | Window level message prompt
*/
7. $UD.toast(msg) 

/**
 * Request the UlanziDeck to pop up a selection dialog box: select file
 *  @param {string} filter Optional | File filter. Filter file type, such as "filter": "image(*.jpg *.png *.gif)" or filter file file(*.txt *.json) etc.
 * Please receive the selection result of this request through the onSelectdialog event
*/
8. $UD.selectFileDialog(filter) 


/**
 * Request the UlanziDeck to pop up a selection dialog box: select a folder
 * Please receive the selection result of this request through the onSelectdialog event
*/
9. $UD.selectFolderDialog() 


/**
 * Request the UlanziDeck to use the browser to open the url
 * @param {string} url Required | Supports remote paths and local paths, supports opening url links under the plug-in root directory (links starting with / ./)
 * @param {local} boolean Optional | true if it is a local path
*/
10. $UD.openUrl(url, local) 


/**
 * Request the UlanziDeck to display a pop-up window; After the pop-up window, test.html needs to actively close it, and test to window.close() to notify the pop-up window to close
 *  @param {string} url Required | Local HTML path
 * @param {string} width Optional | Window width, default 200
 * @param {string} height Optional | Window height, default 200
 * @param {string} x Optional | The x coordinate of the window. If no value is passed, it will be centered by default.
 * @param {string} y Optional | The y coordinate of the window. If no value is passed, it will be centered by default.
*/
11. $UD.openView(url, width = 200, height = 200, x , y ) 



```